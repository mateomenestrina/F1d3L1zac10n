<!DOCTYPE html> 
<html>
	<head>
		<meta charset="utf-8">

		<meta name="viewport" content="user-scalable=no,width=device-width, initial-scale=1, maximum-scale=1">
 
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		
		<script src="libs/jquery-1.8.3.min.js"></script>
		<script src="libs/jquery-barcode.min.js"></script>
		<script src="libs/jquery.transit.min.js"></script>
		 

		<link rel="stylesheet" type="text/css" href="estilo.css">
	</head>

	<body>
		
		<script src="cordova.js"></script>
		<script src="cdv-plugin-fb-connect.js"></script>
		<script src="facebook-js-sdk.js"></script>

		<script src="js/Facebook.js"></script>
		<script src="js/Boton.js"></script>

		<script>
			
			//var SERVER = 'http://192.168.235.153/fidelizacion_server/';
			var SERVER = 'http://www.mdinteractivo.com/fidelizacion_server/';
			var _uid = 0;
			var _access_token = '';
			var _name = '';
			var _Facebook;
			var btn_connect;
			var uid_code = ''
			document.addEventListener('deviceready', deviceready, false);



			function deviceready(){

				btn_connect = new Boton("INICAR SESSION", doConnect, 'BotonAzul')
				btn_connect.main.id = 'connect'
				$('#connect').append(btn_connect.main)

				
				if ((typeof cordova == 'undefined') && (typeof Cordova == 'undefined')) alert('Cordova variable does not exist. Check that you have included cordova.js correctly');
				if (typeof CDV == 'undefined') alert('CDV variable does not exist. Check that you have included cdv-plugin-fb-connect.js correctly');
				if (typeof FB == 'undefined') alert('FB variable does not exist. Check that you have included the Facebook JS SDK file.');
			

				try{

					_Facebook = new Facebook();
					_Facebook.init();

					_Facebook.esta_coenctado(function($bool){
						if($bool)  mostrar_home();
						else mostrar_connect();
					})

				}catch(e){

					_uid = '123456789012345123324333';
					_name = 'Local Host';
					mostrar_home();

				}
				
				$('#btn_mi_codigo').bind('touchstart', function(){
					
					$('#codigo').toggle();
					$('#compras').hide();

				})

				$('#btn_mis_compras').bind('touchstart', function(){
					
					$('#codigo').hide();
					$('#compras').toggle();
					if($('#compras').css('display')=='none') return;
					$('#loading').show();

					$.ajax({

							type: "GET",
							url: SERVER + "xml.get.php",
							dataType: 'xml',
							cache: false, 
							data:{uid: uid_code},

							success: function($xml) {
								
								var obj = $.parseJSON($($xml).find('compras').text())
								var _html = '';
								var cant = 0;
								for(var item_compra in obj){
									
									_html += '<div class="registro_compra"><div class="c_id">Compra #' + obj[item_compra].compras_id + '</div><div class="c_precio">' + obj[item_compra].compras_precio + ' $</div><div class="c_puntos">' + obj[item_compra].compras_puntos + ' pts.</div><br style="clear:both"></div>';
									cant += Number( obj[item_compra].compras_puntos);

								}

								_html += '<div id="cantidad_puntos">total '+cant+' pts.</div>';
								$('#compras').html(_html);
								$('#loading').hide();
								$
							},
							error: function(){ 
								$('#loading').hide()
							}
						});	

				})



			}				

			function doConnect(){
				 
				_Facebook.conectar(conecto_ok);

			}

			function conecto_ok(){

			    mostrar_home();

			}

			function mostrar_connect(){

				$('#home').hide()
				$('#connect').show()

			}

			function mostrar_home(){
				
				var resto = 13 - _uid.toString().length;
				var txt_resto = '';
				
				for(var i = 0; i< resto; i++){
					txt_resto +='0';
				}

				uid_code = txt_resto + '' + _uid 
				
				if(_uid.toString().length>13) uid_code = _uid.toString().substr(0,13)

				$("#nombre").html('Bienvenido, ' + _name)
				$("#codigo > div").barcode(uid_code, "ean13", {barWidth:2, barHeight:90});     
				$('#home').show();
				$('#connect').hide();

			}

	
		
		</script>

	<div id='content'>

		<div id="connect" style='display:none'>

		</div> 

		<div id="home" style='display:none'>
				
			<div id='nombre'></div>
			<div id='btn_mi_codigo' class='item_menu_home'>MI CODIGO ></div>
			<div id='codigo' style='display:none'><div></div></div>
			<div id='btn_mis_compras' class='item_menu_home'>MIS COMPRAS ></div>
			<div id='compras'  style='display:none'></div>

		</div>   


       <div id="loading" style='display:none'><div id="txt_loading"></div><div class="spinner"><div class="bar1"></div><div class="bar2"></div><div class="bar3"></div><div class="bar4"></div><div class="bar5"></div><div class="bar6"></div><div class="bar7"></div><div class="bar8"></div><div class="bar9"></div><div class="bar10"></div><div class="bar11"></div><div class="bar12"></div></div></div>
		
      </div>

	</body>
</html>